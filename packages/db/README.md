# @canopy/db

Database layer for Canopy using Drizzle ORM with Neon PostgreSQL.

## Setup

### 1. Create a Neon Database

1. Go to [console.neon.tech](https://console.neon.tech)
2. Create a new project
3. Copy your connection string

### 2. Configure Environment Variables

Create a `.env` file in the root of the monorepo:

```bash
DATABASE_URL=postgresql://username:password@ep-cool-darkness-123456.us-east-2.aws.neon.tech/canopy?sslmode=require
```

### 3. Push Schema to Database

For development, you can push the schema directly:

```bash
pnpm db:push
```

For production, generate and run migrations:

```bash
pnpm db:generate
pnpm db:migrate
```

## Scripts

- `pnpm db:generate` - Generate migration files from schema
- `pnpm db:migrate` - Run pending migrations
- `pnpm db:push` - Push schema changes directly (dev only)
- `pnpm db:studio` - Launch Drizzle Studio (visual database explorer)
- `pnpm db:check` - Check for schema issues

## Usage

```typescript
import { db, users } from '@canopy/db'

// Query users
const allUsers = await db.select().from(users)

// Insert user
const newUser = await db
	.insert(users)
	.values({
		email: 'user@example.com',
		name: 'John Doe',
	})
	.returning()

// Type-safe queries with inference
type User = typeof users.$inferSelect
type NewUser = typeof users.$inferInsert
```

## Schema

The schema is located in `src/schema/` and is organized by domain:

- `users.ts` - User accounts

## Migrations

Migrations are stored in `migrations/` and are automatically generated by Drizzle Kit when you run `pnpm db:generate`.
